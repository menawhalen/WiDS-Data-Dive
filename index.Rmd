---
title: "WiDS Chicago/Evanston Data Dive"
date: March 8, 2019
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---
# Overview

Welcome to the WiDS Data Dive, in partnership with the Chicago/Illinois Red Cross.

You will have **90 minutes** to complete the following task. 

Below is a plot of number of incidents per month from 2014-2018 that the Illinois Red Cross responded to. As you can see, even ignoring seasonality, we observe a *drop* in total incidents in 2018. Our questions is simple: **Why**?

![](motivating_plot.png)

**NOTE**: This is not a question that we or the Red Cross definetively know the answer to. Feel free to be as creative as time allows!

The data is described more below in the [the data](#the-data). We will give you a zip file to [download](#download) that has: 

* Red Cross incident data 
* [Data cleaning](#basic-cleaning) script in R
* Shapefile for zip codes in Chicago, and an example [spatial data cleaning R script](#spatial-data) that merges this with an outside csv based on zip code
* Data by zipcode from 2006-2010 ACS that includes Mean Income, Median Income, and Population for each zip 
* Weather data
* National fire data



## Goal
Your team will need to create 2-3 slides (keep it simple) with your best visualization and text takeaways. 

Please email your 2 slides with the email subject: "DATA DIVE", and a list of team members names to <als1@u.northwestern.edu> by 6:45 pm. 

Winner gets...bragging rights and eternal WiDS-dom and fame. 


# The Data

## Codebook
The code book will list each variable name with a description followed by the variable type in italics. If variable is categorical responses will be listed.

  * Date - The date an incident report was created *Date dd/mm/yyyy*
  * Incident_num - Assigned per incident by DCSOps, the Red Cross incident management application. The first two numbers represent the fiscal year. The last four are sequential starting at the beginning of the fiscal year (July 1). Note that duplicate and invalid incidents as well as events to which the Red Cross deems a response is not needed (like a fire in a commercial or institutional building) have been removed from the dataset *Character*
  * Incident_type - The type of situation that lead to an incident *Character*
      + Blizzard
      + Building Collapse
      + Explosion
      + Fire
      + Flood
      + HazMat
      + No response needed - An incident for which the local jurisdiction determines that Red Cross services are not needed
      + Police - An incident, like a shooting or hostage situation, for which assistance is provided directly to first responders in the form of food and hydration
      + Search and rescue 
      + Storm
      + Tornado
      + Transportation -Typically, a vehicle into a residential structure or a train derailment
      + Vacate - An incident in which a disaster has not occurred but living conditions are deemed unsafe for residents
  * City - Location city of incident *Character*
  * State - Location state of incident *Character*
  * ZIP - ZIP Code of where the incident occured. *Numeric*
  * County - The county where the incident occured *Character*
  * Latitude - Latitude of incident *Numeric*
  * Longitude - Longitude of incident *Numeric*
  * Destroyed - Number of residential units destroyed
  * Major - Number of residential units suffering major damage
  * Minor - Number of residential units suffering minor damage
  * Affected - Number of residential units nominally affected
  * Injured - Number of people injured from the incident *Numeric*
  * Hospitalized - Number of people hospitalized from the incident *Numeric*
  * Desceased - Number of people that died from incident *Numeric*
  * Adults - Number of adults in the incident *Numeric*
  * Children - Number of children in the incident *Numeric*
  * Families - Number of families in the incident *Numeric*
  * Assistance - Amount of total financial assistance provided *Numeric* 
  * Verified - The time and date the incident is verified by a Red Cross dispatcher *Timestamp dd/mm/yyyy 00:00:00 AM*
  * Dispatched - The time and date it is determined by a Red Cross dispatcher that a response is required *Timestamp dd/mm/yyyy 00:00:00 AM*
  * Responders_ID - The time and date a volunteer response team is identified by a Red Cross dispatcher *Timestamp dd/mm/yyyy 00:00:00 AM*
  * On_scene - The time and date the volunteer response team arrives at an incident scene *Timestamp dd/mm/yyyy 00:00:00 AM*
  * Departed - The time and date the volunteer response team departs the incident scene *Timestamp dd/mm/yyyy 00:00:00 AM*

## Download




# Let's Get To Work... in R!

## Basic Cleaning
Below is some R code for downloading the data and doing some basic cleaning.
```{r basicclean, warning=FALSE, message=FALSE}
# Libraries for reading URL and csv
library(RCurl) 
library(readr)
# read in the text file for red cross from github 
red_cross_text<-getURL("https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/Redcross.csv")
# puts into a csv with the first row of table being the column names, seperated by ","
red_cross<-read.csv(text = red_cross_text, header = TRUE, sep = ",")
# puts all the dates and time stamps in the right format for R
red_cross$Date<-as.Date(red_cross$Date, format = "%m/%d/%Y")
red_cross$Verified<-as.POSIXct(red_cross$Verified, format = "%m/%d/%Y %H:%M")
red_cross$Dispatched<-as.POSIXct(red_cross$Dispatched, format = "%m/%d/%Y %H:%M")
red_cross$Responders_ID<-as.POSIXct(red_cross$Responders_ID, format = "%m/%d/%Y %H:%M")
red_cross$On_scene<-as.POSIXct(red_cross$On_scene, format = "%m/%d/%Y %H:%M")
red_cross$Departed<-as.POSIXct(red_cross$Departed, format = "%m/%d/%Y %H:%M")

# looking at each column to see how many NA's are in the column
na_count <-sapply(red_cross, function(y) sum(length(which(is.na(y))))) 
```

## Spatial Data 

```{r spatialdata, message=FALSE, warning=FALSE}
#load necessary packages
require(dplyr)
require(rgdal) #for spatial data
require(RColorBrewer) #for heatmaps!

#shp: spatial data ZIP FILE: contains several spatial data types for plotting
#pop_income_data is from 2006-2010 ACS and has the mean income, median income, and population for a zip
## OUTPUT: will generate heatmap of Chicago zipcodes, with number of incidents scaled to the population in the zip
merge_spatial_data <- function(shp, pop_income_data, red_cross){
  
  #unzip zip file with several files necessary for plotting the zip code
  download.file(paste('https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/', shp, sep = "/"), destfile = "geo_zipcodes.zip")
  system("unzip geo_zipcodes.zip")
  
  #here's your shapefile!
  spatial <- readOGR( dsn =  getwd()) 
  
  
  other_data <- read_csv(getURL(paste('https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/', pop_income_data, sep = "/")))
  
  #merge demographic (population + income) data with shapefile
  shp_merged <- merge(spatial, other_data, by.x = 'zip', by.y = 'Zip')
  
  #merge in Red Cross Data with shapefile
  shp_merged@data <- merge(shp_merged@data, red_cross, by.x = 'zip', by.y = 'ZIP')
  
  p <- colorRampPalette(c("white", "red"))(128)
  palette(p)
  
  #calculate the Red Cross incident rate per each zip, scaled by population
  zip_and_rate <- shp_merged@data %>%
    group_by(zip, Pop) %>% 
    summarise(count = n()) %>% summarise(rate = count/Pop)
  
  # Scale the total population to the palette
  zip_and_rate <- na.omit(zip_and_rate)
  cols <- (zip_and_rate$rate - min(zip_and_rate$rate))/diff(range(zip_and_rate$rate))*120 + 1
  plot(shp_merged, col = cols)
  
}


#LET'S TEST!
merge_spatial_data('geo_zipcodes.zip', 'population_income.csv', red_cross)

```



## Timestamp Problems
Some of the timestamp variables like Verified and  On_Scene have errors from encoding incorrectly upon data entry. They have timestamps that start in the year 1900 or have the time Red Cross learns about the incident happening after the Red Cross arrived on the scene of the incident or left the incident. This is leading to negative time for the Red Cross getting to the incident or negative time when the Red Cross is at the incident. Here is some code that changes those timestamp variables to be missing (NA) if they are before the dataset time period or lead to negative times to get to the scene or time at the incident. 
```{r timestamp, warning=FALSE, message=FALSE}
# packages for mutate and using dates
library(dplyr) 
library(lubridate)
# creates a new variable for the time it takes for the Red Cross to be on the scene in minutes
red_cross$time_to_inc<-difftime(red_cross$On_scene,red_cross$Verified, units = "min")
# creates a new variable for the time the Red Cross is at the incident in minutes
red_cross$time_of_inc<-difftime(red_cross$Departed, red_cross$On_scene, units = "min")
# creates a new data frame from the red cross that makes all the timestamp variable be after 2014 and on
# as well as make sure that the time to and time of variable is not negative
red_cross_time <-red_cross %>%
  mutate(Verified = if_else(Verified > ymd("2013-12-31"), Verified, as.POSIXct(NA)), 
         Dispatched = ifelse(Dispatched > ymd("2013-12-31"), Dispatched, as.POSIXct(NA)),
         Responders_ID =ifelse(Responders_ID > ymd("2013-12-31"), Responders_ID, as.POSIXct(NA)),
         On_scene = ifelse(On_scene > ymd("2013-12-31"), On_scene, as.POSIXct(NA)),
         Departed = ifelse(Departed > ymd("2013-12-31"), Departed, as.POSIXct(NA)),
         time_to_inc =ifelse(time_to_inc >-1,time_to_inc, as.POSIXct(NA)),
         time_of_inc = ifelse(time_of_inc >-1, time_of_inc, as.POSIXct(NA)))
# look at the median time the Red Cross takes to get to the scene
median(red_cross_time$time_to_inc, na.rm = T)
# look at the median time the Red Cross spends at an incient
median(red_cross_time$time_of_inc, na.rm = T)

```
