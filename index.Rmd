---
title: "WiDS Chicago/Evanston Data Dive"
date: March 8, 2019
output:
  html_document:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---
# Overview

Welcome to the WiDS Data Dive, in partnership with the Chicago/Illinois Red Cross.

You will have **90 minutes** to complete the following task. 

Below is a plot of number of incidents per month from 2014-2018 that the Illinois Red Cross responded to. As you can see, even ignoring seasonality, we observe a *drop* in total incidents in 2018. Our questions is simple: **Why**?

![](motivating_plot.png)

**NOTE**: This is not a question that we or the Red Cross definetively know the answer to. Feel free to be as creative as time allows!

The data is described more below in the [the data](#the-data). We will give you a zip file to [download](#download) that has: 

* Red Cross incident data 
* [Data cleaning](#basic-cleaning) script in R
* Shapefile for zip codes in Chicago, and an example [spatial data cleaning R script](#spatial-data) that merges this with an outside csv based on zip code
* Data by zipcode from 2006-2010 ACS that includes Mean Income, Median Income, and Population for each zip code

## Goal
Your team will need to create 2-3 slides (keep it simple) with your best visualization and text takeaways. 

Please email your 2 slides with the email subject: "DATA DIVE", and a list of team members names to <als1@u.northwestern.edu> by 6:45 pm. 

Winner gets...bragging rights and eternal WiDS-dom and fame. 


# The Data

## Codebook
The code book will list each variable name with a description followed by the variable type in italics. If variable is categorical responses will be listed.

  * date - The date an incident report was created *Date dd/mm/yyyy*
  * incident_num - Assigned per incident by DCSOps, the Red Cross incident management application. The first two numbers represent the fiscal year. The last four are sequential starting at the beginning of the fiscal year (July 1). Note that duplicate and invalid incidents as well as events to which the Red Cross deems a response is not needed (like a fire in a commercial or institutional building) have been removed from the dataset *Numeric*
  * incident_type - The type of situation that lead to an incident *Character*
      + Blizzard
      + Building Collapse
      + Explosion
      + Fire
      + Flood
      + HazMat
      + No response needed - An incident for which the local jurisdiction determines that Red Cross services are not needed
      + Police - An incident, like a shooting or hostage situation, for which assistance is provided directly to first responders in the form of food and hydration
      + Search and rescue 
      + Storm
      + Tornado
      + Transportation -Typically, a vehicle into a residential structure or a train derailment
      + Vacate - An incident in which a disaster has not occurred but living conditions are deemed unsafe for residents
  * city - Location city of incident (*Character*)
  * state - Location state of incident (*Character*)
  * zip - ZIP Code of where the incident occured. (*Numeric*)
  * County - The county where the incident occured (*Character*)
  * latitude - Latitude of incident (*Numeric*)
  * longitude - Longitude of incident (*Numeric*)
  * destroyed - Number of residential units destroyed
  * major - Number of residential units suffering major damage
  * minor - Number of residential units suffering minor damage
  * affected - Number of residential units nominally affected
  * injured - Number of people injured from the incident (*Numeric*)
  * hospitalized - Number of people hospitalized from the incident (*Numeric*)
  * desceased - Number of people that died from incident (*Numeric*)
  * adults - Number of adults in the incident (*Numeric*)
  * children - Number of children in the incident (*Numeric*)
  * families - Number of families in the incident (*Numeric*)
  * assistance - Amount of total financial assistance provided *Numeric* 
  * verified - The time and date the incident is verified by a Red Cross dispatcher (*Timestamp dd/mm/yyyy 00:00:00 AM*)
  * dispatched - The time and date it is determined by a Red Cross dispatcher that a response is required (*Timestamp dd/mm/yyyy 00:00:00 AM*)
  * responders_ID - The time and date a volunteer response team is identified by a Red Cross dispatcher (*Timestamp dd/mm/yyyy 00:00:00 AM*)
  * on_scene - The time and date the volunteer response team arrives at an incident scene (*Timestamp dd/mm/yyyy 00:00:00 AM*)
  * departed - The time and date the volunteer response team departs the incident scene (*Timestamp dd/mm/yyyy 00:00:00 AM*)

#General Workflow Suggestions



## Download




# Let's Get To Work... in R!

## Basic Cleaning
Below is some R code for downloading already cleaned data. Has all dates and timestamps coded to be the correct type, also changed incident_num to an integer without a dash.
```{r download, warning=FALSE, message=FALSE}
require(readr)
require(naniar) #for all you R nerds, here is the a new package that is great for handling missingness

download.file("https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/Redcross.rds", 
              "Redcross.rds",
              method="curl")

red_cross<- read_rds("Redcross.rds")

missingness_info<-red_cross %>% miss_var_summary() #displays number and percent of NAs in each column 
```


Below is the code to create the cleaned rds file.

```{r howtoclean, warning=FALSE, message=FALSE, eval=FALSE}
# Libraries for reading URL and csv and cleaning 
require(RCurl) 
require(dplyr)
require(janitor)

# read in the text file for red cross from Github 
red_cross_text<-getURL("https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/Redcross.csv")

# puts into a csv with the first row of table being the column names, seperated by ","
red_cross<-read.csv(text = red_cross_text, header = TRUE, sep = ",") %>%
  as_tibble() %>% # puts into a tibble
  clean_names() %>% #makes names lowercase column names
  # puts all the dates and time stamps in the right format for R
  mutate(date=as.Date(date, format = "%m/%d/%Y"),
         verified=as.POSIXct(verified, format = "%m/%d/%Y %H:%M"),
         dispatched=as.POSIXct(dispatched, format = "%m/%d/%Y %H:%M"),
         responders_id=as.POSIXct(responders_id, format = "%m/%d/%Y %H:%M"),
         on_scene=as.POSIXct(on_scene, format = "%m/%d/%Y %H:%M"),
         departed=as.POSIXct(departed, format = "%m/%d/%Y %H:%M"),
         incident_num=as.character(incident_num),
         incident_num=as.integer(gsub("-", "", incident_num))) # makes incident number a integer

write_rds(red_cross, "Redcross.rds")

```

## Spatial Data 

Our incident data has as a zip code variable. The below example code joins Red Cross incident data with spatial data based on zip code, and makes a map of the number of incidents in 2018. 

The below code also creates a data frame (`zip_income_pop_dat`)from the ACS Community Survey (ACS) 2010 Data for income + population (mean, median) per zip. It should be ready for you to join + map away! 

```{r spatialdata, message=FALSE, warning=FALSE}
# Illinois Zip Code Map ----------------------------------------------------

# Loading packages ------------------------------------------------------------
require(tidyverse)
require(rgdal)
require(maptools)
require(maps)
require(mapproj)
require(ggthemes)
require(RCurl)
require(lubridate)
require(janitor)
require(hms)

download.file("https://raw.githubusercontent.com/menawhalen/WiDS_Data_Dive/master/Redcross.rds", 
              "Redcross.rds",
              method="curl")
keep_zip_codes <- read_rds("Redcross.rds") %>% 
  as_tibble() %>% 
  clean_names() %>%  #makes names lowercase column names
  mutate(zip = zip %>% as.character()) %>% #we decide to make all zip codes
  select(zip)

# Forming Chicago Zip Map Tibble ------------------------------------------

il_map_dat <- readOGR(dsn="tl_2010_17_zcta510.shp") #read in IL zip codes shapefile 
il_map_dat@data$id <- rownames(il_map_dat@data)
il_points <- fortify(il_map_dat, region = "ZCTA5CE10") %>% #fortify helps us turn the map into data points in a data frame 
  as_tibble() %>% 
  filter(id %in% keep_zip_codes$zip)
  
#creating mapping dataset 
il_map_df <- full_join(il_points, il_map_dat@data, by="id") %>% 
  as_tibble() 

#loads data with zip code, mean/median income and population
zip_income_pop_dat <- read_csv(file = "population_income.csv") %>% 
  clean_names() %>% #all lowercase
  mutate(zip = zip %>% as.character()) #we choose to make the zip codes as character

red_cross <- read_rds("Redcross.rds") %>% 
  as_tibble() %>% 
  clean_names() %>% 
  mutate(zip = zip %>% as.character())

zip_raw_count <- red_cross %>% 
  mutate(year = year(date)) %>% 
  group_by(zip, year) %>% 
  summarise(incident_count = n()) %>% #counts the number of incidents in each zip code in each year
  ungroup() %>% 
  filter(year == 2018) %>% #we just will look at 2018
  mutate(more_than_10 = case_when(incident_count <= 5 ~ "< 5",
                                  incident_count <= 10 ~ "5-10",
                                  TRUE ~ ">10")) #make discrete coloring scale


# make the plot!
il_map_df %>% 
  left_join(zip_raw_count, by = c("id" = "zip")) %>% 
  ggplot(aes(long, lat , group = group, fill = more_than_10)) + 
    geom_polygon() +
    geom_path(color = "black") +
    coord_quickmap() +
    theme_map() +  ggtitle('Incidents Per Zip Code in 2018')


```



## Timestamp Problems

Some of the timestamp variables like `Verified` and  `On_Scene` have errors from encoding incorrectly upon data entry.

The two main errors were: 

  * timestamps that start in the year 1900 (not in 2014-2018 )
  * "arrival of Red Cross" timestamps LATER than "dispatched (left to go to incident)" (not logical)

The below code changes these errornous timestamps to `NA`.

```{r timestamp, warning=FALSE, message=FALSE, eval=F}
require(dplyr)
require(lubridate)

# creates a new variable for the time it takes for the Red Cross to be on the scene in minutes
red_cross$time_to_inc <- difftime(red_cross$On_scene,red_cross$Verified, units = "min")

# creates a new variable for the time the Red Cross is at the incident in minutes
red_cross$time_of_inc <- difftime(red_cross$Departed, red_cross$On_scene, units = "min")

# creates a new data frame from the red cross that makes all the timestamp variable be after 2014 and on
# as well as make sure that the time to and time of variable is not negative
red_cross_time <-red_cross %>%
  mutate(Verified = if_else(Verified > ymd("2013-12-31"), Verified, as.POSIXct(NA)), 
         Dispatched = ifelse(Dispatched > ymd("2013-12-31"), Dispatched, as.POSIXct(NA)),
         Responders_ID =ifelse(Responders_ID > ymd("2013-12-31"), Responders_ID, as.POSIXct(NA)),
         On_scene = ifelse(On_scene > ymd("2013-12-31"), On_scene, as.POSIXct(NA)),
         Departed = ifelse(Departed > ymd("2013-12-31"), Departed, as.POSIXct(NA)),
         time_to_inc =ifelse(time_to_inc >-1,time_to_inc, as.POSIXct(NA)),
         time_of_inc = ifelse(time_of_inc >-1, time_of_inc, as.POSIXct(NA)))

# look at the median time the Red Cross takes to get to the scene
median(red_cross_time$time_to_inc, na.rm = T)

# look at the median time the Red Cross spends at an incient
median(red_cross_time$time_of_inc, na.rm = T)

```
